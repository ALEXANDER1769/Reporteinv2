<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte de Producci√≥n de Leche - PYSIGA</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --verde: #2f6f4e;
  --azul: #2c4f7c;
  --naranja: #f39c12; /* Color para leche */
  --fondo: #f7f9f8;
}
body {
  font-family: system-ui, Arial;
  background: var(--fondo);
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 1200px;
  margin: auto;
  background: white;
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.1);
}
h1 {
  color: var(--naranja);
  margin-bottom: 15px;
  text-align: center;
}
.kpi-container {
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  gap: 20px;
  margin: 20px 0;
  text-align: center;
}
.kpi-box {
  background: linear-gradient(135deg, #f9f3e9, #f1e0c5);
  padding: 20px;
  border-radius: 10px;
  min-width: 150px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.kpi-value {
  font-size: 36px;
  font-weight: bold;
  color: var(--naranja);
  margin-bottom: 5px;
}
.kpi-label {
  font-size: 14px;
  color: #555;
}
.section {
  margin-bottom: 40px;
}
.section h2 {
  color: var(--azul);
  border-left: 4px solid var(--naranja);
  padding-left: 12px;
  margin-bottom: 20px;
}
.grafico-container {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 25px;
}
canvas {
  max-width: 100%;
  height: 300px !important;
}
#loader {
  text-align: center;
  padding: 60px 20px;
  font-size: 20px;
  color: var(--azul);
}
.vaca {
  font-size: 60px;
  animation: mover 1.2s infinite alternate;
  margin-bottom: 20px;
}
@keyframes mover {
  from { transform: translateX(-8px) rotate(-5deg); }
  to { transform: translateX(8px) rotate(5deg); }
}
.btn-volver {
  background: var(--azul);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  margin: 30px auto 0;
  font-size: 16px;
  display: block;
  font-weight: bold;
  transition: all 0.2s;
}
.btn-volver:hover {
  background: #1e3a5f;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.btn-volver:active {
  transform: translateY(0);
}
.error {
  color: #c0392b;
  padding: 20px;
  background: #fadbd8;
  border-radius: 10px;
  margin: 30px 0;
  text-align: center;
  font-size: 16px;
  display: none;
  border-left: 4px solid #c0392b;
}
</style>
</head>
<body>
<div class="container">
  <h1>ü•õ Reporte de Producci√≥n de Leche</h1>

  <div id="loader">
    <div class="vaca">üêÑ</div>
    <div>Cargando datos de producci√≥n...</div>
  </div>

  <div id="contenido" style="display:none">
    <!-- KPIs -->
    <div class="section">
        <div class="kpi-container">
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-prod-total">0</div>
                <div class="kpi-label">Lts Totales</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-prom-dia">0.0</div>
                <div class="kpi-label">Prom. Diario (Lts)</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-vacas-prom">0</div>
                <div class="kpi-label">Vacas Orde√±adas (Prom.)</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-value" id="kpi-dias-reg">0</div>
                <div class="kpi-label">D√≠as con Registros</div>
            </div>
        </div>
    </div>

    <!-- Gr√°fico Producci√≥n Diaria -->
    <div class="section">
      <h2>Producci√≥n Diaria de Leche</h2>
      <div class="grafico-container">
        <canvas id="graficoProdDiaria"></canvas>
      </div>
    </div>

    <!-- Gr√°fico Producci√≥n por Av√≠o -->
    <div class="section">
      <h2>Producci√≥n por Turno (Av√≠o)</h2>
      <div class="grafico-container">
        <canvas id="graficoProdAvio"></canvas>
      </div>
    </div>

    <!-- Gr√°fico Top Productores -->
    <div class="section">
      <h2>Top 10 Productores (Promedio)</h2>
      <div class="grafico-container">
        <canvas id="graficoTopProductores"></canvas>
      </div>
    </div>

    <button class="btn-volver" id="btnVolver">‚¨Ö Cerrar reporte y volver al panel</button>
  </div>

  <div id="error" class="error"></div>
</div>

<script>
let datosReporte = {};

document.addEventListener('DOMContentLoaded', function() {
  console.log("üöÄ Iniciando reporte de producci√≥n de leche...");

  const params = new URLSearchParams(window.location.search);
  const email = params.get("email");

  if (!email) {
    mostrarError("Acceso no autorizado. Inicie sesi√≥n desde el panel principal.");
    return;
  }

  console.log("üìß Email:", email);

  fetch("https://pysiga.d-alexjose.workers.dev", { // ASEGURATE DE USAR TU URL DE WORKER
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ accion: "reporteProduccionLeche", email: email })
  })
  .then(response => {
    if (!response.ok) throw new Error("Error del servidor: " + response.status);
    return response.json();
  })
  .then(data => {
    console.log("‚úÖ Datos de leche recibidos:", data);

    if (!data.ok) {
      throw new Error(data.error || "Respuesta inv√°lida del servidor");
    }

    datosReporte = data;

    // Actualizar KPIs
    document.getElementById("kpi-prod-total").textContent = datosReporte.kpis.produccionTotal.toFixed(2);
    document.getElementById("kpi-prom-dia").textContent = datosReporte.kpis.promedioDiario.toFixed(2);
    document.getElementById("kpi-vacas-prom").textContent = datosReporte.kpis.vacasPromedioOrde√±adas.toFixed(1);
    document.getElementById("kpi-dias-reg").textContent = datosReporte.kpis.diasConRegistros;

    // Renderizar gr√°ficos
    renderizarGraficoProdDiaria();
    renderizarGraficoProdAvio();
    renderizarGraficoTopProductores();

    // Mostrar contenido y ocultar loader
    document.getElementById("loader").style.display = "none";
    document.getElementById("contenido").style.display = "block";

    document.getElementById("btnVolver").addEventListener("click", function() {
      console.log("‚úÖ Cerrando pesta√±a del reporte...");
      window.close();
    });
  })
  .catch(err => {
    console.error("‚ùå Error:", err);
    mostrarError("Error al cargar los datos de producci√≥n: " + err.message);
  });
});

function renderizarGraficoProdDiaria() {
  const datos = datosReporte.prodDiaria;
  if (datos.length === 0) {
    document.getElementById("graficoProdDiaria").parentElement.innerHTML =
      "<p style='text-align:center;color:#999'>No hay datos de producci√≥n diaria</p>";
    return;
  }

  const fechas = datos.map(d => d.fecha);
  const producciones = datos.map(d => d.produccion);

  const ctx = document.getElementById("graficoProdDiaria").getContext("2d");
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: fechas,
      datasets: [{
        label: 'Producci√≥n (Lts)',
        data: producciones,
        borderColor: '#f39c12',
        backgroundColor: 'rgba(243, 156, 18, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.3,
        pointRadius: 5,
        pointBackgroundColor: '#f39c12',
        pointHoverRadius: 7,
        pointHoverBackgroundColor: '#1e3a5f'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true },
        tooltip: {
          callbacks: {
            label: context => `Producci√≥n: ${context.parsed.y} Lts`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Litros' },
          grid: { color: 'rgba(0,0,0,0.05)' }
        },
        x: {
          title: { display: true, text: 'Fecha' },
          grid: { display: false },
          ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 10 }
        }
      }
    }
  });
}

function renderizarGraficoProdAvio() {
  const datos = datosReporte.prodAvio;
  if (datos.length === 0) {
    document.getElementById("graficoProdAvio").parentElement.innerHTML =
      "<p style='text-align:center;color:#999'>No hay datos por Av√≠o</p>";
    return;
  }

  // Agrupar datos por fecha y av√≠o
  const datosAgrupados = {};
  datos.forEach(d => {
    if (!datosAgrupados[d.fecha]) {
        datosAgrupados[d.fecha] = { am: 0, pm: 0 };
    }
    if (d.avio === 'am') {
        datosAgrupados[d.fecha].am += d.produccion;
    } else if (d.avio === 'pm') {
        datosAgrupados[d.fecha].pm += d.produccion;
    }
  });

  const fechas = Object.keys(datosAgrupados).sort();
  const produccionAM = fechas.map(fecha => datosAgrupados[fecha].am);
  const produccionPM = fechas.map(fecha => datosAgrupados[fecha].pm);

  const ctx = document.getElementById("graficoProdAvio").getContext("2d");
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: fechas,
      datasets: [
        {
          label: 'Ma√±ana (AM)',
          data: produccionAM,
          backgroundColor: '#f1c40f',
          borderColor: '#f39c12',
          borderWidth: 1
        },
        {
          label: 'Tarde (PM)',
          data: produccionPM,
          backgroundColor: '#e67e22',
          borderColor: '#d35400',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: context => `${context.dataset.label}: ${context.parsed.y} Lts`
          }
        }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Litros' } },
        x: { title: { display: true, text: 'Fecha' } }
      }
    }
  });
}

function renderizarGraficoTopProductores() {
  const datos = datosReporte.topProductores;
  if (datos.length === 0) {
    document.getElementById("graficoTopProductores").parentElement.innerHTML =
      "<p style='text-align:center;color:#999'>No hay datos de promedio de productores</p>";
    return;
  }

  const ids = datos.map(d => d.numeroPractico || d.id);
  const promedios = datos.map(d => d.promedioProduccion);

  const ctx = document.getElementById("graficoTopProductores").getContext("2d");
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ids,
      datasets: [{
        label: 'Promedio Producci√≥n (Lts/D√≠a)',
        data: promedios,
        backgroundColor: ids.map((_, i) => `hsl(${i * 30}, 60%, 55%)`),
        borderColor: ids.map((_, i) => `hsl(${i * 30}, 60%, 40%)`),
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y', // Para gr√°fico horizontal
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: context => `${context.parsed.x.toFixed(2)} Lts/D√≠a`
          }
        }
      },
      scales: {
        x: { beginAtZero: true, title: { display: true, text: 'Litros por D√≠a' } },
        y: { title: { display: true, text: 'ID Animal' } }
      }
    }
  });
}

function mostrarError(mensaje) {
  document.getElementById("loader").style.display = "none";
  const err = document.getElementById("error");
  err.textContent = mensaje;
  err.style.display = "block";
}
</script>
</body>
</html>