<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte de Inventario - PYSIGA</title>
<!-- Chart.js - SIN ESPACIOS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --verde: #2f6f4e;
  --azul: #2c4f7c;
  --fondo: #f7f9f8;
}
body {
  font-family: system-ui, Arial;
  background: var(--fondo);
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 1200px;
  margin: auto;
  background: white;
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.1);
}
h1 {
  color: var(--azul);
  margin-bottom: 15px;
  text-align: center;
}
.numero-total {
  font-size: 64px;
  font-weight: bold;
  color: var(--verde);
  text-align: center;
  margin: 20px 0;
}
.subtitulo {
  text-align: center;
  color: #666;
  margin-bottom: 30px;
  font-size: 18px;
}
.section {
  margin-bottom: 40px;
}
.section h2 {
  color: var(--azul);
  border-left: 4px solid var(--verde);
  padding-left: 12px;
  margin-bottom: 20px;
}
.grafico-container {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 25px;
}
canvas {
  max-width: 100%;
  height: 300px !important;
}
#loader {
  text-align: center;
  padding: 60px 20px;
  font-size: 20px;
  color: var(--azul);
}
.vaca {
  font-size: 60px;
  animation: mover 1.2s infinite alternate;
  margin-bottom: 20px;
}
@keyframes mover {
  from { transform: translateX(-8px) rotate(-5deg); }
  to { transform: translateX(8px) rotate(5deg); }
}
.btn-volver {
  background: var(--azul);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  margin: 30px auto 0;
  font-size: 16px;
  display: block;
  font-weight: bold;
  transition: all 0.2s;
}
.btn-volver:hover {
  background: #1e3a5f;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.btn-volver:active {
  transform: translateY(0);
}
.error {
  color: #c0392b;
  padding: 20px;
  background: #fadbd8;
  border-radius: 10px;
  margin: 30px 0;
  text-align: center;
  font-size: 16px;
  display: none;
  border-left: 4px solid #c0392b;
}
</style>
</head>
<body>
<div class="container">
  <h1>üìä Reporte de Inventario Ganadero</h1>

  <div id="loader">
    <div class="vaca">üêÑ</div>
    <div>Cargando datos ganaderos...</div>
  </div>

  <div id="contenido" style="display:none">

    <!-- TOTAL GENERAL -->
    <div class="section">
      <div class="numero-total" id="total-general">0</div>
      <div class="subtitulo">Animales en inventario actual</div>
    </div>

    <!-- GR√ÅFICO POR LOTE -->
    <div class="section">
      <h2>Inventario por Lote</h2>
      <div class="grafico-container">
        <canvas id="graficoLote"></canvas>
      </div>
    </div>

    <!-- GR√ÅFICO POR TIPO -->
    <div class="section">
      <h2>Inventario por Tipo</h2>
      <div class="grafico-container">
        <canvas id="graficoTipo"></canvas>
      </div>
    </div>

    <!-- GR√ÅFICO DE HIST√ìRICO -->
    <div class="section">
      <h2>Historial de Inventario</h2>
      <div class="grafico-container">
        <canvas id="graficoHistorico"></canvas>
      </div>
    </div>

    <button class="btn-volver" id="btnVolver">‚¨Ö Cerrar reporte y volver al panel</button>
  </div>

  <div id="error" class="error"></div>
</div>

<script>
// Variables para los datos
let totalGeneral = 0;
let datosPorLote = {};
let datosPorTipo = {};
let datosHistorico = [];

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
  console.log("üöÄ Iniciando reporte de inventario...");

  // Obtener email de la URL
  const params = new URLSearchParams(window.location.search);
  const email = params.get("email");

  if (!email) {
    mostrarError("Acceso no autorizado. Inicie sesi√≥n desde el panel principal.");
    return;
  }

  console.log("üìß Email:", email);

  // Fetch con POST (CORREGIDO - SIN ESPACIOS EN URL)
  fetch("https://pysiga.d-alexjose.workers.dev", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ accion: "reporteInventario", email: email })
  })
  .then(response => {
    if (!response.ok) throw new Error("Error del servidor: " + response.status);
    return response.json();
  })
  .then(data => {
    console.log("‚úÖ Datos recibidos:", data);

    if (!data.ok) {
      throw new Error(data.error || "Respuesta inv√°lida del servidor");
    }

    // Extraer datos
    totalGeneral = data.total || 0;
    datosPorLote = data.porLote || {};
    datosPorTipo = data.porTipo || {};
    datosHistorico = data.historico || [];

    console.log("üìä Total:", totalGeneral);
    console.log("üìä Por Lote:", datosPorLote);
    console.log("üìä Por Tipo:", datosPorTipo);
    console.log("üìä Hist√≥rico:", datosHistorico.length, "registros");

    if (totalGeneral === 0 && datosHistorico.length === 0) {
      throw new Error("No se encontraron registros de inventario");
    }

    // Renderizar gr√°ficos
    document.getElementById("total-general").textContent = totalGeneral;
    renderizarGraficoLote();
    renderizarGraficoTipo();
    renderizarGraficoHistorico();

    // Mostrar contenido y ocultar loader
    document.getElementById("loader").style.display = "none";
    document.getElementById("contenido").style.display = "block";

    // Configurar bot√≥n de volver (CIERRA esta pesta√±a)
    document.getElementById("btnVolver").addEventListener("click", function() {
      console.log("‚úÖ Cerrando pesta√±a del reporte...");
      window.close();
    });
  })
  .catch(err => {
    console.error("‚ùå Error:", err);
    mostrarError("Error al cargar los datos: " + err.message);
  });
});

// Gr√°fico por Lote
function renderizarGraficoLote() {
  const lotes = Object.keys(datosPorLote);
  const cantidades = Object.values(datosPorLote);

  if (lotes.length === 0) {
    document.getElementById("graficoLote").parentElement.innerHTML =
      "<p style='text-align:center;color:#999'>No hay datos por lote</p>";
    return;
  }

  const ctx = document.getElementById("graficoLote").getContext("2d");
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: lotes,
      datasets: [{
        label: 'Cantidad',
        data: cantidades,
        backgroundColor: lotes.map((_, i) => `hsl(${i * 40}, 60%, 55%)`),
        borderColor: lotes.map((_, i) => `hsl(${i * 40}, 60%, 40%)`),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: context => `${context.parsed.y} animales`
          }
        }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Cantidad' } },
        x: { title: { display: true, text: 'Lote' } }
      }
    }
  });
}

// Gr√°fico por Tipo
function renderizarGraficoTipo() {
  const tipos = Object.keys(datosPorTipo);
  const cantidades = Object.values(datosPorTipo);

  if (tipos.length === 0) {
    document.getElementById("graficoTipo").parentElement.innerHTML =
      "<p style='text-align:center;color:#999'>No hay datos por tipo</p>";
    return;
  }

  const ctx = document.getElementById("graficoTipo").getContext("2d");
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: tipos,
      datasets: [{
        data: cantidades,
        backgroundColor: tipos.map((_, i) => `hsl(${i * 60 + 200}, 70%, 60%)`),
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' },
        tooltip: {
          callbacks: {
            label: context => `${context.label}: ${context.parsed} animales`
          }
        }
      }
    }
  });
}

// Gr√°fico de Hist√≥rico
function renderizarGraficoHistorico() {
  if (datosHistorico.length === 0) {
    document.getElementById("graficoHistorico").parentElement.innerHTML =
      "<p style='text-align:center;color:#999'>No hay datos hist√≥ricos</p>";
    return;
  }

  // Tomar √∫ltimos 20 registros
  const ultimos = datosHistorico.slice(-20);
  const fechas = [];
  const cantidades = [];

  ultimos.forEach((registro, index) => {
    // Extraer fecha (probando m√∫ltiples nombres)
    let fecha = registro.fecha || registro.Fecha || registro["Fecha/Hora"] || 'Sin fecha';
    fechas.push(fecha);

    // Extraer cantidad (probando m√∫ltiples nombres)
    let cantidad = registro.cantidad || registro.Cantidad || registro["TOTAL GENERAL"] || registro.total || 0;
    cantidades.push(parseInt(cantidad));
  });

  // Verificar si hay datos num√©ricos v√°lidos
  const hayDatosValidos = cantidades.some(c => !isNaN(c) && c > 0);

  if (!hayDatosValidos) {
    console.warn("‚ö†Ô∏è No hay datos num√©ricos v√°lidos en el hist√≥rico");
    document.getElementById("graficoHistorico").parentElement.innerHTML =
      "<p style='text-align:center;color:#999'>No hay datos num√©ricos v√°lidos</p>";
    return;
  }

  const ctx = document.getElementById("graficoHistorico").getContext("2d");
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: fechas,
      datasets: [{
        label: 'Cantidad total',
        data: cantidades,
        borderColor: '#2f6f4e',
        backgroundColor: 'rgba(47, 111, 78, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.3,
        pointRadius: 6,
        pointBackgroundColor: '#2f6f4e',
        pointHoverRadius: 8,
        pointHoverBackgroundColor: '#1e3a5f'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true },
        tooltip: {
          callbacks: {
            label: context => `Cantidad: ${context.parsed.y}`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Cantidad' },
          grid: { color: 'rgba(0,0,0,0.05)' }
        },
        x: {
          title: { display: true, text: 'Fecha' },
          grid: { display: false },
          ticks: {
            maxRotation: 45,
            minRotation: 45,
            autoSkip: true,
            maxTicksLimit: 10
          }
        }
      }
    }
  });
}

// Mostrar error
function mostrarError(mensaje) {
  document.getElementById("loader").style.display = "none";
  const err = document.getElementById("error");
  err.textContent = mensaje;
  err.style.display = "block";
}
</script>
</body>
</html>
