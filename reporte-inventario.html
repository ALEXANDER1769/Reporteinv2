<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte de Inventario - PYSIGA</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --verde: #2f6f4e;
  --azul: #2c4f7c;
  --fondo: #f7f9f8;
}
body {
  font-family: system-ui, Arial, sans-serif;
  background: var(--fondo);
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 1200px;
  margin: auto;
  background: #fff;
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 3px 12px rgba(0,0,0,.1);
}
h1 {
  text-align: center;
  color: var(--azul);
}
.numero-total {
  font-size: 64px;
  font-weight: bold;
  color: var(--verde);
  text-align: center;
  margin: 20px 0;
}
.subtitulo {
  text-align: center;
  color: #666;
  margin-bottom: 30px;
}
.section {
  margin-bottom: 40px;
}
.section h2 {
  color: var(--azul);
  border-left: 4px solid var(--verde);
  padding-left: 12px;
}
.grafico-container {
  background: #fff;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,.08);
}
canvas {
  width: 100%;
  height: 320px !important;
}
#loader {
  text-align: center;
  padding: 60px 20px;
  font-size: 20px;
  color: var(--azul);
}
.vaca {
  font-size: 60px;
  animation: mover 1.2s infinite alternate;
}
@keyframes mover {
  from { transform: translateX(-8px); }
  to   { transform: translateX(8px); }
}
.error {
  display: none;
  background: #fadbd8;
  color: #c0392b;
  padding: 20px;
  border-radius: 10px;
  margin-top: 30px;
  text-align: center;
}
.btn-volver {
  background: var(--azul);
  color: #fff;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  display: block;
  margin: 30px auto 0;
}
.btn-volver:hover {
  background: #1e3a5f;
}
</style>
</head>

<body>
<div class="container">

<h1>üìä Reporte de Inventario Ganadero</h1>

<div id="loader">
  <div class="vaca">üêÑ</div>
  Cargando datos ganaderos‚Ä¶
</div>

<div id="contenido" style="display:none">

  <div class="section">
    <div class="numero-total" id="total-general">0</div>
    <div class="subtitulo">Animales en inventario actual</div>
  </div>

  <div class="section">
    <h2>Inventario por Lote</h2>
    <div class="grafico-container">
      <canvas id="graficoLote"></canvas>
    </div>
  </div>

  <div class="section">
    <h2>Inventario por Tipo</h2>
    <div class="grafico-container">
      <canvas id="graficoTipo"></canvas>
    </div>
  </div>

  <div class="section">
    <h2>Historial de Inventario</h2>
    <div class="grafico-container">
      <canvas id="graficoHistorico"></canvas>
    </div>
  </div>

  <button class="btn-volver" onclick="volverPanel()">‚¨Ö Volver al panel</button>
</div>

<div id="error" class="error"></div>

</div>

<script>
(function () {

  /* ===============================
     LEER EMAIL
  =============================== */
  const params = new URLSearchParams(window.location.search);
  const email = params.get("email");

  if (!email) {
    mostrarError("Acceso no autorizado. Inicie sesi√≥n desde el panel principal.");
    return;
  }

  /* ===============================
     FETCH BACKEND
  =============================== */
  fetch("https://pysiga.d-alexjose.workers.dev", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      accion: "reporteInventario",
      email: email
    })
  })
  .then(r => {
    if (!r.ok) throw new Error("HTTP " + r.status);
    return r.json();
  })
  .then(data => {
    if (!data.ok) {
      mostrarError(data.error || "Respuesta inv√°lida del servidor");
      return;
    }

    document.getElementById("total-general").textContent = data.total || 0;

    renderizarGraficoLote(data.porLote || {});
    renderizarGraficoTipo(data.porTipo || {});
    renderizarGraficoHistorico(data.historico || []);

    document.getElementById("loader").style.display = "none";
    document.getElementById("contenido").style.display = "block";
  })
  .catch(err => {
    mostrarError("Error al cargar datos: " + err.message);
  });

  /* ===============================
     GRAFICOS
  =============================== */

  function renderizarGraficoLote(datos) {
    new Chart(document.getElementById("graficoLote"), {
      type: "bar",
      data: {
        labels: Object.keys(datos),
        datasets: [{
          data: Object.values(datos),
          backgroundColor: "#2f6f4e"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  function renderizarGraficoTipo(datos) {
    new Chart(document.getElementById("graficoTipo"), {
      type: "doughnut",
      data: {
        labels: Object.keys(datos),
        datasets: [{
          data: Object.values(datos),
          backgroundColor: ["#2f6f4e","#2c4f7c","#8b6f47","#7f8c8d"]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  function renderizarGraficoHistorico(hist) {
    const fechas = hist.map(r => r.fecha || "‚Äî");
    const valores = hist.map(r => Number(r.total || 0));

    new Chart(document.getElementById("graficoHistorico"), {
      type: "line",
      data: {
        labels: fechas,
        datasets: [{
          data: valores,
          borderColor: "#2f6f4e",
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } }
      }
    });
  }

  /* ===============================
     UTILIDADES
  =============================== */

  function mostrarError(msg) {
    document.getElementById("loader").style.display = "none";
    const e = document.getElementById("error");
    e.textContent = msg;
    e.style.display = "block";
  }

  window.volverPanel = function () {
    window.location.href = "https://www.pysiga.com";
  };

})();
</script>

</body>
</html>
