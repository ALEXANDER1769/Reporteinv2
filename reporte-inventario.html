<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte Inventario</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
body{font-family:Arial;background:#f7f9f8;margin:0;padding:20px}
.container{max-width:1200px;margin:auto;background:white;border-radius:12px;padding:25px;box-shadow:0 3px 12px rgba(0,0,0,0.1)}
h1{color:#2c4f7c;text-align:center;margin-bottom:15px}
.numero-total{font-size:64px;font-weight:bold;color:#2f6f4e;text-align:center;margin:20px 0}
#loader{text-align:center;padding:60px 20px;font-size:20px;color:#2c4f7c}
.vaca{font-size:60px;animation:mover 1.2s infinite alternate;margin-bottom:20px}
@keyframes mover{from{transform:translateX(-8px) rotate(-5deg)}to{transform:translateX(8px) rotate(5deg)}}
canvas{max-width:100%;height:300px!important}
.btn-volver{background:#2c4f7c;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;margin:30px auto 0;font-size:16px;display:block;font-weight:bold}
.btn-volver:hover{background:#1e3a5f}
.error{color:#c0392b;padding:20px;background:#fadbd8;border-radius:10px;margin:30px 0;text-align:center;font-size:16px;display:none}
</style>
</head>
<body>
<div class="container">
  <h1>üìä Reporte de Inventario</h1>
  
  <div id="loader">
    <div class="vaca">üêÑ</div>
    <div>Cargando...</div>
  </div>
  
  <div id="contenido" style="display:none">
    <div class="numero-total" id="total-general">0</div>
    
    <div style="margin:40px 0">
      <h2>Inventario por Lote</h2>
      <canvas id="graficoLote"></canvas>
    </div>
    
    <div style="margin:40px 0">
      <h2>Inventario por Tipo</h2>
      <canvas id="graficoTipo"></canvas>
    </div>
    
    <div style="margin:40px 0">
      <h2>Historial</h2>
      <canvas id="graficoHistorico"></canvas>
    </div>
    
    <button class="btn-volver" id="btnVolver">Cerrar y volver al panel</button>
  </div>
  
  <div id="error" class="error"></div>
</div>

<script>
Chart.register(ChartDataLabels);

let totalGeneral = 0;
let datosPorLote = {};
let datosPorTipo = {};
let datosHistorico = [];

document.addEventListener('DOMContentLoaded', function() {
  console.log("Iniciando...");
  
  const params = new URLSearchParams(window.location.search);
  const email = params.get("email");
  
  if (!email) {
    mostrarError("Error: email no encontrado");
    return;
  }
  
  console.log("Email:", email);
  
  fetch("https://pysiga.d-alexjose.workers.dev", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ accion: "reporteInventario", email: email })
  })
  .then(response => {
    console.log("Respuesta:", response.status);
    if (!response.ok) throw new Error("Error: " + response.status);
    return response.json();
  })
  .then(data => {
    console.log("Datos:", data);
    
    if (!data.ok) throw new Error(data.error || "Error del servidor");
    
    totalGeneral = data.total || 0;
    datosPorLote = data.porLote || {};
    datosPorTipo = data.porTipo || {};
    datosHistorico = data.historico || [];
    
    console.log("Total:", totalGeneral);
    console.log("Lote:", datosPorLote);
    console.log("Tipo:", datosPorTipo);
    console.log("Historico:", datosHistorico.length);
    
    document.getElementById("total-general").textContent = totalGeneral;
    renderizarGraficoLote();
    renderizarGraficoTipo();
    renderizarGraficoHistorico();
    
    document.getElementById("loader").style.display = "none";
    document.getElementById("contenido").style.display = "block";
    
    document.getElementById("btnVolver").addEventListener("click", function() {
      console.log("Cerrando...");
      window.close();
    });
  })
  .catch(err => {
    console.error("Error:", err);
    mostrarError("Error: " + err.message);
  });
});

function renderizarGraficoLote() {
  const lotes = Object.keys(datosPorLote);
  const cantidades = Object.values(datosPorLote);
  
  if (lotes.length === 0) return;
  
  new Chart(document.getElementById("graficoLote"), {
    type: 'bar',
     {
      labels: lotes,
      datasets: [{
        label: 'Cantidad',
         cantidades,
        backgroundColor: lotes.map((_, i) => `hsl(${i * 40}, 60%, 55%)`),
        borderColor: lotes.map((_, i) => `hsl(${i * 40}, 60%, 40%)`),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          display: true,
          color: '#000',
          font: { weight: 'bold', size: 16 },
          formatter: (value) => value,
          anchor: 'end',
          align: 'top'
        }
      },
      scales: {
        y: { beginAtZero: true },
        x: {}
      }
    }
  });
}

function renderizarGraficoTipo() {
  const tipos = Object.keys(datosPorTipo);
  const cantidades = Object.values(datosPorTipo);
  
  if (tipos.length === 0) return;
  
  new Chart(document.getElementById("graficoTipo"), {
    type: 'doughnut',
     {
      labels: tipos,
      datasets: [{
         cantidades,
        backgroundColor: tipos.map((_, i) => `hsl(${i * 60 + 200}, 70%, 60%)`),
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' },
        datalabels: {
          display: true,
          color: '#fff',
          font: { weight: 'bold', size: 14 },
          formatter: (value, context) => {
            const total = context.dataset.data.reduce((a, b) => a + b, 0);
            const percentage = Math.round((value / total) * 100);
            return `${value}\n(${percentage}%)`;
          },
          textStrokeColor: '#000',
          textStrokeWidth: 2
        }
      }
    }
  });
}

function renderizarGraficoHistorico() {
  if (datosHistorico.length === 0) return;
  
  const ultimos = datosHistorico.slice(-20);
  const fechas = [];
  const cantidades = [];
  
  ultimos.forEach(registro => {
    const fecha = registro.fecha || registro.Fecha || 'Sin fecha';
    const cantidad = registro.cantidad || registro.Cantidad || registro["TOTAL GENERAL"] || registro.total || 0;
    fechas.push(fecha);
    cantidades.push(parseInt(cantidad) || 0);
  });
  
  const hayDatosValidos = cantidades.some(c => !isNaN(c) && c > 0);
  if (!hayDatosValidos) return;
  
  new Chart(document.getElementById("graficoHistorico"), {
    type: 'line',
     {
      labels: fechas,
      datasets: [{
        label: 'Cantidad',
         cantidades,
        borderColor: '#2f6f4e',
        backgroundColor: 'rgba(47, 111, 78, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.3,
        pointRadius: 6,
        pointBackgroundColor: '#2f6f4e'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true },
        datalabels: { display: false }
      },
      scales: {
        y: { beginAtZero: true },
        x: { ticks: { maxRotation: 45, minRotation: 45 } }
      }
    }
  });
}

function mostrarError(mensaje) {
  document.getElementById("loader").style.display = "none";
  const err = document.getElementById("error");
  err.textContent = mensaje;
  err.style.display = "block";
}
</script>
</body>
</html>
