<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte de Inventario - PYSIGA</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --verde: #2f6f4e;
  --azul: #2c4f7c;
  --tierra: #8b6f47;
  --fondo: #f7f9f8;
}
body {
  font-family: system-ui, Arial;
  background: var(--fondo);
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 1200px;
  margin: auto;
  background: white;
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.1);
}
h1 {
  color: var(--azul);
  margin-bottom: 15px;
  text-align: center;
}
.numero-total {
  font-size: 64px;
  font-weight: bold;
  color: var(--verde);
  text-align: center;
  margin: 20px 0;
  line-height: 1;
}
.subtitulo {
  text-align: center;
  color: #666;
  margin-bottom: 30px;
  font-size: 18px;
}
.section {
  margin-bottom: 40px;
}
.section h2 {
  color: var(--azul);
  border-left: 4px solid var(--verde);
  padding-left: 12px;
  margin-bottom: 20px;
}
.grafico-container {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 25px;
}
canvas {
  max-width: 100%;
  height: 300px !important;
}
#loader {
  text-align: center;
  padding: 60px 20px;
  font-size: 20px;
  color: var(--azul);
}
.vaca {
  font-size: 60px;
  animation: mover 1.2s infinite alternate;
  margin-bottom: 20px;
}
@keyframes mover {
  from { transform: translateX(-8px) rotate(-5deg); }
  to { transform: translateX(8px) rotate(5deg); }
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  font-size: 14px;
  overflow-x: auto;
}
th {
  background: var(--verde);
  color: white;
  padding: 10px;
  text-align: left;
  position: sticky;
  top: 0;
}
td {
  padding: 9px;
  border-bottom: 1px solid #eee;
}
tr:hover td {
  background: #f9f9f9;
}
.btn-volver {
  background: var(--azul);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  margin: 30px auto 0;
  font-size: 16px;
  display: block;
  font-weight: bold;
  transition: all 0.2s;
}
.btn-volver:hover {
  background: #1e3a5f;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.btn-volver:active {
  transform: translateY(0);
}
.error {
  color: #c0392b;
  padding: 20px;
  background: #fadbd8;
  border-radius: 10px;
  margin: 30px 0;
  text-align: center;
  font-size: 16px;
  display: none;
  border-left: 4px solid #c0392b;
}
@media (max-width: 768px) {
  .numero-total { font-size: 48px; }
  canvas { height: 250px !important; }
  .btn-volver { width: 90%; }
}
</style>
</head>
<body>
<div class="container">
  <h1>üìä Reporte de Inventario Ganadero</h1>
  
  <div id="loader">
    <div class="vaca">üêÑ</div>
    <div>Cargando datos ganaderos...</div>
  </div>
  
  <div id="contenido" style="display:none">
    
    <!-- TOTAL GENERAL -->
    <div class="section">
      <div class="numero-total" id="total-general">0</div>
      <div class="subtitulo">Animales en inventario actual</div>
    </div>
    
    <!-- GR√ÅFICO POR LOTE -->
    <div class="section">
      <h2>Inventario por Lote</h2>
      <div class="grafico-container">
        <canvas id="graficoLote"></canvas>
      </div>
    </div>
    
    <!-- GR√ÅFICO POR TIPO -->
    <div class="section">
      <h2>Inventario por Tipo</h2>
      <div class="grafico-container">
        <canvas id="graficoTipo"></canvas>
      </div>
    </div>
    
    <!-- GR√ÅFICO DE EVOLUCI√ìN (HIST√ìRICO) -->
    <div class="section">
      <h2>Evoluci√≥n de Pesos</h2>
      <div class="grafico-container">
        <canvas id="graficoHistorico"></canvas>
      </div>
    </div>
    
    <!-- TABLA DETALLADA -->
    <div class="section">
      <h2>Detalle del Hist√≥rico</h2>
      <div id="tabla-container"></div>
    </div>
    
    <button class="btn-volver" onclick="volverPanel()">‚¨Ö Volver al panel principal</button>
  </div>
  
  <div id="error" class="error"></div>
</div>

<script>
(function() {
  // 1Ô∏è‚É£ Leer email desde URL
  const params = new URLSearchParams(window.location.search);
  const email = params.get("email");
  
  if (!email) {
    mostrarError("Acceso no autorizado. Inicie sesi√≥n desde el panel principal.");
    return;
  }

  // 2Ô∏è‚É£ FETCH CORRECTO: POST con estructura que espera tu Apps Script
  fetch("https://pysiga.d-alexjose.workers.dev", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      accion: "reporteInventario",
      email: email
    })
  })
  .then(response => {
    if (!response.ok) throw new Error("Error del servidor: " + response.status);
    return response.json();
  })
  .then(data => {
    console.log("Datos recibidos:", data);
    
    if (!data.ok) {
      mostrarError("Error del servidor: " + (data.error || "Respuesta inv√°lida"));
      return;
    }
    
    // 3Ô∏è‚É£ CORRECCI√ìN CLAVE: usar las propiedades correctas (con may√∫sculas como tu backend las env√≠a)
    const total = data.total || 0;
    const porLote = data.porLote || {};
    const porTipo = data.porTipo || {};
    const historico = data.historico || [];
    
    if (total === 0 && historico.length === 0) {
      mostrarError("No se encontraron registros de inventario para este usuario");
      return;
    }
    
    // Renderizar todo
    document.getElementById("total-general").textContent = total;
    renderizarGraficoLote(porLote);
    renderizarGraficoTipo(porTipo);
    renderizarGraficoHistorico(historico);
    renderizarTabla(historico);
    
    // Mostrar contenido
    document.getElementById("loader").style.display = "none";
    document.getElementById("contenido").style.display = "block";
  })
  .catch(err => {
    console.error("Error completo:", err);
    mostrarError("Error al cargar los datos: " + err.message);
  });

  // 4Ô∏è‚É£ GR√ÅFICO POR LOTE
  function renderizarGraficoLote(datos) {
    const lotes = Object.keys(datos);
    const cantidades = Object.values(datos);
    
    if (lotes.length === 0) {
      document.getElementById("graficoLote").parentElement.innerHTML = 
        "<p style='text-align:center;color:#999'>No hay datos por lote</p>";
      return;
    }
    
    new Chart(document.getElementById("graficoLote"), {
      type: 'bar',
      data: {
        labels: lotes,
        datasets: [{
          label: 'Cantidad de animales',
          data: cantidades,
          backgroundColor: lotes.map((_, i) => 
            `hsl(${i * 40}, 60%, 55%)`
          ),
          borderColor: lotes.map((_, i) => 
            `hsl(${i * 40}, 60%, 40%)`
          ),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: context => `${context.parsed.y} animales`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Cantidad' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: {
            title: { display: true, text: 'Lote' },
            grid: { display: false }
          }
        }
      }
    });
  }

  // 5Ô∏è‚É£ GR√ÅFICO POR TIPO
  function renderizarGraficoTipo(datos) {
    const tipos = Object.keys(datos);
    const cantidades = Object.values(datos);
    
    if (tipos.length === 0) {
      document.getElementById("graficoTipo").parentElement.innerHTML = 
        "<p style='text-align:center;color:#999'>No hay datos por tipo</p>";
      return;
    }
    
    new Chart(document.getElementById("graficoTipo"), {
      type: 'doughnut',
      data: {
        labels: tipos,
        datasets: [{
          data: cantidades,
          backgroundColor: tipos.map((_, i) => 
            `hsl(${i * 60 + 200}, 70%, 60%)`
          ),
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: 'right',
            labels: {
              padding: 20,
              font: { size: 14 }
            }
          },
          tooltip: {
            callbacks: {
              label: context => `${context.label}: ${context.parsed} animales`
            }
          }
        }
      }
    });
  }

  // 6Ô∏è‚É£ GR√ÅFICO DE EVOLUCI√ìN (HIST√ìRICO)
  function renderizarGraficoHistorico(historico) {
    if (historico.length === 0) {
      document.getElementById("graficoHistorico").parentElement.innerHTML = 
        "<p style='text-align:center;color:#999'>No hay datos hist√≥ricos</p>";
      return;
    }
    
    // Tomar √∫ltimos 20 registros para no saturar
    const ultimos = historico.slice(-20);
    const fechas = ultimos.map(r => r.fecha || r.Fecha || 'Sin fecha');
    const pesos = ultimos.map(r => parseFloat(r["peso total"] || r.peso_total || r["Peso Total"] || 0));
    
    new Chart(document.getElementById("graficoHistorico"), {
      type: 'line',
      data: {
        labels: fechas,
        datasets: [{
          label: 'Peso Total (kg)',
          data: pesos,
          borderColor: '#2f6f4e',
          backgroundColor: 'rgba(47, 111, 78, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.3,
          pointRadius: 4,
          pointBackgroundColor: '#2f6f4e'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: context => `Peso total: ${context.parsed.y} kg`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            title: { display: true, text: 'Peso (kg)' },
            grid: { color: 'rgba(0,0,0,0.05)' }
          },
          x: {
            title: { display: true, text: 'Fecha' },
            grid: { display: false }
          }
        }
      }
    });
  }

  // 7Ô∏è‚É£ TABLA DETALLADA
  function renderizarTabla(historico) {
    if (historico.length === 0) {
      document.getElementById("tabla-container").innerHTML = 
        "<p style='text-align:center;color:#999;padding:20px'>No hay registros hist√≥ricos</p>";
      return;
    }
    
    let html = `<table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Lote</th>
          <th>Tipo</th>
          <th>Cantidad</th>
          <th>Peso Total (kg)</th>
        </tr>
      </thead>
      <tbody>`;
    
    historico.slice(-30).reverse().forEach(row => {
      html += `<tr>
        <td>${row.fecha || row.Fecha || '-'}</td>
        <td>${row.lote || row.Lote || '-'}</td>
        <td>${row.tipo || row.Tipo || '-'}</td>
        <td>${row.cantidad || row.Cantidad || '0'}</td>
        <td>${row["peso total"] || row.peso_total || row["Peso Total"] || '0'}</td>
      </tr>`;
    });
    
    html += `</tbody></table>
      <p style="text-align:right;font-size:13px;color:#888;margin-top:10px">
        Mostrando √∫ltimos ${Math.min(30, historico.length)} registros de ${historico.length} totales
      </p>`;
    
    document.getElementById("tabla-container").innerHTML = html;
  }

  // 8Ô∏è‚É£ FUNCIONES AUXILIARES
  function mostrarError(mensaje) {
    document.getElementById("loader").style.display = "none";
    const err = document.getElementById("error");
    err.textContent = mensaje;
    err.style.display = "block";
  }

  function volverPanel() {
    window.location.href = "https://www.pysiga.com";
  }
})();
</script>
</body>
</html>
