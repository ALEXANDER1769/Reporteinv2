<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Reporte de Inventario - PYSIGA</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{--verde:#2f6f4e;--azul:#2c4f7c;--fondo:#f7f9f8}
body{font-family:system-ui,Arial;background:var(--fondo);margin:0;padding:20px}
.container{max-width:1200px;margin:auto;background:#fff;border-radius:12px;padding:25px;box-shadow:0 3px 12px rgba(0,0,0,.1)}
h1{text-align:center;color:var(--azul)}
.numero-total{font-size:64px;font-weight:bold;color:var(--verde);text-align:center}
.subtitulo{text-align:center;color:#666;margin-bottom:30px}
.section{margin-bottom:40px}
.section h2{color:var(--azul);border-left:4px solid var(--verde);padding-left:12px}
.grafico-container{background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
canvas{width:100%;height:320px!important}
#loader{text-align:center;padding:60px;font-size:20px;color:var(--azul)}
.error{display:none;background:#fadbd8;color:#c0392b;padding:20px;border-radius:10px;text-align:center}
.btn-volver{background:var(--azul);color:#fff;border:none;padding:12px 26px;border-radius:8px;cursor:pointer;font-weight:bold;display:block;margin:30px auto 0}
.btn-volver:hover{background:#1e3a5f}
</style>
</head>

<body>
<div class="container">

<h1>ðŸ“Š Reporte de Inventario Ganadero</h1>

<div id="loader">Cargando datosâ€¦</div>

<div id="contenido" style="display:none">

  <div class="section">
    <div class="numero-total" id="total-general">0</div>
    <div class="subtitulo">Animales en inventario actual</div>
  </div>

  <div class="section">
    <h2>Inventario por Lote</h2>
    <div class="grafico-container"><canvas id="graficoLote"></canvas></div>
  </div>

  <div class="section">
    <h2>Inventario por Tipo</h2>
    <div class="grafico-container"><canvas id="graficoTipo"></canvas></div>
  </div>

  <div class="section">
    <h2>Historial de Inventario</h2>
    <div class="grafico-container"><canvas id="graficoHistorico"></canvas></div>
  </div>

  <button class="btn-volver" onclick="volverPanel()">â¬… Volver al panel</button>
</div>

<div id="error" class="error"></div>

</div>

<script>
(function(){

/* ===============================
   PARAMETROS
=============================== */
const params = new URLSearchParams(location.search);
const email  = params.get("email");
const retorno = params.get("return"); // ðŸ‘ˆ CLAVE

if(!email){
  mostrarError("Acceso no autorizado");
  return;
}

/* ===============================
   FETCH
=============================== */
fetch("https://pysiga.d-alexjose.workers.dev",{
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({ accion:"reporteInventario", email })
})
.then(r=>r.json())
.then(d=>{
  if(!d.ok){ mostrarError(d.error||"Error"); return; }

  total-general.textContent = d.total || 0;

  new Chart(graficoLote,{
    type:"bar",
    data:{ labels:Object.keys(d.porLote||{}),
           datasets:[{ data:Object.values(d.porLote||{}),
                       backgroundColor:"#2f6f4e"}] }
  });

  new Chart(graficoTipo,{
    type:"doughnut",
    data:{ labels:Object.keys(d.porTipo||{}),
           datasets:[{ data:Object.values(d.porTipo||{}),
                       backgroundColor:["#2f6f4e","#2c4f7c","#8b6f47"]}] }
  });

  new Chart(graficoHistorico,{
    type:"line",
    data:{ labels:(d.historico||[]).map(x=>x.fecha),
           datasets:[{ data:(d.historico||[]).map(x=>x.total),
                       borderColor:"#2f6f4e",
                       fill:true }] }
  });

  loader.style.display="none";
  contenido.style.display="block";
})
.catch(e=>mostrarError(e.message));

function mostrarError(m){
  loader.style.display="none";
  error.textContent=m;
  error.style.display="block";
}

/* ===============================
   RETORNO SIN BUCLE
=============================== */
window.volverPanel = function(){
  if (retorno) {
    location.href = retorno + "?email=" + encodeURIComponent(email);
  } else {
    location.href = "https://www.pysiga.com/panel?email=" + encodeURIComponent(email);
  }
};

})();
</script>

</body>
</html>
