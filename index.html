<!-- reporte-inventario.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte de Inventario - PYSIGA</title>
    <style>
        /* Tus estilos aquí */
        body {
            margin: 0;
            background: #f4f6f9;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
            overflow: hidden;
            padding: 20px;
        }
        .card {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
            margin-bottom: 30px;
        }
        .total {
            text-align: center;
        }
        .total h2 {
            margin: 0;
            color: #555;
        }
        .total .numero {
            font-size: 48px;
            font-weight: bold;
            color: #2c7be5;
        }
        canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Reporte de Inventario</h1>
    <!-- Card para el total -->
    <div class="card total">
        <h2>Total de animales</h2>
        <div id="totalAnimales" class="numero">Cargando...</div>
    </div>

    <!-- Card para el gráfico de lotes -->
    <div class="card">
        <h3 style="margin-bottom:20px;color:#555">
            Cantidad de animales por lote
        </h3>
        <canvas id="graficoLotesCanvas"></canvas>
    </div>

    <!-- Card para el gráfico de tipos -->
    <div class="card">
        <h3 style="margin-bottom:20px;color:#555">
            Cantidad de animales por tipo
        </h3>
        <canvas id="graficoTiposCanvas"></canvas>
    </div>

    <!-- Card para el gráfico histórico -->
    <div class="card">
        <h3 style="margin-bottom:20px;color:#555">
            Histórico de Inventario
        </h3>
        <canvas id="graficoHistoricoCanvas"></canvas>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const WORKER_URL = "https://pysiga.d-alexjose.workers.dev"; // Asegúrate que apunte a tu worker
    let graficoLotes = null;
    let graficoTipos = null;
    let graficoHistorico = null;

    // Función para obtener el parámetro 'email' de la URL
    function getEmailFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('email');
    }

    // Cargar el reporte de inventario
    async function cargarReporteInventario() {
        const email = getEmailFromUrl();
        if (!email) {
            console.error("No se encontró el email en la URL.");
            document.getElementById("totalAnimales").innerText = "Error: Email no encontrado";
            return;
        }

        console.log("Intentando cargar reporte para el email:", email);

        try {
            const res = await fetch(WORKER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    accion: "reporteInventario",
                    email: email
                })
            });

            // --- MANEJO DE ERRORES DE RED/HTTP ---
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            // -------------------------------------

            const responseText = await res.text(); // Obtener texto plano
            console.log("Respuesta bruta del Worker:", responseText);

            let data;
            try {
                 data = JSON.parse(responseText);
            } catch (parseError) {
                 console.error("Error al parsear JSON:", parseError);
                 console.error("Texto recibido:", responseText);
                 document.getElementById("totalAnimales").innerText = "Error: Formato de datos inválido";
                 return;
            }

            // --- MANEJO DE ERRORES DE NEGOCIO ---
            if (!data || typeof data !== 'object' || !data.ok) {
                console.error("Error recibido del backend:", data?.error || "Respuesta inválida o sin 'ok: true'");
                document.getElementById("totalAnimales").innerText = `Error: ${data?.error || "Comunicación fallida"}`;
                return;
            }
            // ------------------------------------

            console.log("Datos recibidos para reporte:", data);

            // Actualizar total
            document.getElementById("totalAnimales").innerText = data.total || 0;

            // Dibujar gráficos
            dibujarGraficoBarras('graficoLotesCanvas', 'Animales por Lote', data.porLote || {});
            dibujarGraficoBarras('graficoTiposCanvas', 'Animales por Tipo', data.porTipo || {});
            dibujarGraficoLineas('graficoHistoricoCanvas', 'Histórico de Inventario', data.historico || []);

        } catch (error) {
            console.error("Error al comunicarse con el Worker:", error);
            document.getElementById("totalAnimales").innerText = "Error: Comunicación fallida";
        }
    }

    function dibujarGraficoBarras(canvasId, titulo, datos){
        console.log("Dibujando gráfico de barras para:", canvasId, "con datos:", datos);

        const ctx = document.getElementById(canvasId).getContext("2d");

        // Destruir el gráfico anterior si existe
        const chartVarName = `grafico${canvasId.charAt(0).toUpperCase() + canvasId.slice(1).replace('Canvas', '')}`;
        if (window[chartVarName]) {
            window[chartVarName].destroy();
        }

        if (Object.keys(datos).length === 0) {
            console.warn("No hay datos para graficar en", canvasId);
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = "16px Arial";
            ctx.fillStyle = "#999";
            ctx.textAlign = "center";
            ctx.fillText("No hay datos para mostrar", ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        const colores = [
            "#1f77b4","#ff7f0e","#2ca02c","#d62728",
            "#9467bd","#8c564b","#e377c2","#7f7f7f"
        ];

        window[chartVarName] = new Chart(ctx, {
            type: "bar",
            data: { // <-- CORREGIDO
                labels: Object.keys(datos),
                datasets: [{
                    label: titulo,
                    data: Object.values(datos), // <-- CORREGIDO
                    backgroundColor: colores.slice(0, Object.keys(datos).length),
                    borderColor: "#000",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: true } },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks:{ stepSize:1 },
                        title: { display: true, text: 'Cantidad' }
                    },
                     x: {
                        title: { display: true, text: 'Categoría' } // Cambia según el título
                    }
                }
            }
        });
    }

    function dibujarGraficoLineas(canvasId, titulo, datos) {
        console.log("Dibujando gráfico de líneas para:", canvasId, "con datos:", datos);

        const ctx = document.getElementById(canvasId).getContext("2d");

        // Destruir el gráfico anterior si existe
        const chartVarName = `grafico${canvasId.charAt(0).toUpperCase() + canvasId.slice(1).replace('Canvas', '')}`;
        if (window[chartVarName]) {
            window[chartVarName].destroy();
        }

        if (datos.length === 0) {
            console.warn("No hay datos para graficar en", canvasId);
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.font = "16px Arial";
            ctx.fillStyle = "#999";
            ctx.textAlign = "center";
            ctx.fillText("No hay datos para mostrar", ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }

        // Suponiendo que 'datos' es un array de objetos como {fecha: "YYYY-MM-DD", total: numero}
        const fechas = datos.map(d => d.fecha);
        const valores = datos.map(d => d.total);

        window[chartVarName] = new Chart(ctx, {
            type: 'line',
            data: { // <-- CORREGIDO
              labels: fechas,
              datasets: [{
                label: titulo,
                data: valores, // <-- CORREGIDO
                fill: false,
                borderColor: "#4CAF50",
                tension: 0.1
              }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: true } },
                scales: {
                  y: { beginAtZero: true }
                }
            }
        });
    }

    // Iniciar la carga
    cargarReporteInventario();
</script>

</body>
</html>
